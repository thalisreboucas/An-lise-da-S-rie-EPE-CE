---
title: "An√°lise da S√©rie de Consumo de Energia El√©trica no Cear√°"
author: "Thalis Rebou√ßas"
subtitle: "CC0308 - 2025 | Julho 2025 <br><br> Slides:**https://thalisreboucas.github.io/Analise-da-Serie-EPE-CE/#/**"
format: 
  revealjs:
    logo: "images/logo.png"
    width: 1600
    height: 900
    self-contained: false
    incremental: false
    footer: "Slides por Thalis Rebou√ßas, feito em [Quarto](https://quarto.org/docs/presentations/revealjs/index.html). C√≥digo dispon√≠vel [no GitHub](https://github.com/thalisreboucas/Analise-da-Serie-EPE-CE)."
    theme: ["custom.scss"]
    slide-number: c/t
    show-slide-number: all
    hash-type: number
    preview-links: false
---

## Sum√°rio de aprendizagem

::: {style="font-size: 80%;"}
-   Resumo Geral

     1. Motivo da Escolha da S√©rie

     2. Apresenta√ß√£o da S√©rie

-   Estima√ß√£o dos Modelos de S√©rie Temporal

     3. M√©todo de Suaviza√ß√£o Exponencial
     
     4. Metodologia Box-Jenkins
     
     5. An√°lise de Interven√ß√µes
-   Conclus√£o
    
    7. Conclus√£o das an√°lises e modelos
    
    8. Refer√™ncias

:::

# Vamos l√°!

# Motivo da Escolha da S√©rie

## Motivo da  <br> Escolha da S√©rie:

**Qual s√©rie ?**

$$Z_t = \text{Consumo Mensal de Energia El√©trica no Cear√° (Sistema Simples) (2004-2025)}$$

<!--# Descrito por hugo -->
**Por que An√°lisar ?**

- Identificar padr√µes e tend√™ncias no consumo energ√©tico.

- Apoiar pol√≠ticas p√∫blicas para efici√™ncia energ√©tica.

- Entender como fatores como o cresimento da popula√ß√£o e sazonalidade influenciam o consumo.

# Apresenta√ß√£o da s√©rie.

## Apresenta√ß√£o da s√©rie:

- √â uma s√©rie do EPE(Empresa de Pesquisa Energ√©tica) do Minist√©rio de Minas e Energia (MME).

- √â um dado p√∫blico dispon√≠vel desde de 2004 de todos os estados e tipo de consumo [neste link](https://www.epe.gov.br/_layouts/download.aspx?sourceURL=%2Fsites-pt%2Fpublicacoes-dados-abertos%2Fpublicacoes%2FDocuments%2FCONSUMO%2520MENSAL%2520DE%2520ENERGIA%2520EL%25c3%2589TRICA%2520POR%2520CLASSE.xlsx).

Neste caso, vou me restringir a an√°lisar apenas o consumo do Cear√° na parte de consumo de energia el√©trica na rede (MWh) de Sistema Simples.

- √â possiv√©l entender melhor os dados e an√°lises que o governo faz [neste link](https://encurtador.com.br/6qoRG).


## Apresenta√ß√£o da s√©rie:

::: {style="font-size: 70%;"}
A s√©rie come√ßa em janeiro de 2004 e vai at√© mar√ßo de 2025,com isso tem cerca de 255 observa√ß√µes,vamos olhar o **gr√°fico da s√©rie:**

:::

```{r , fig.align='center'}

pacman::p_load(forecast, tseries, ggplot2, patchwork,gridExtra, urca, lubridate, FinTS, zoo,tibble,readxl,datawirzad,tidyverse,timetk,tseries,TSA,tsoutliers,)



# 2. CARREGAMENTO E PREPARA√á√ÉO DOS DADOS
#-----------------------------------------------------------------------
# Carregar o arquivo CSV
file_path <- "C:/Users/thali/Desktop/√Årea de Trabalho/Serie temporal/An√°lise de Energia eletrica industrial do Cear√°/Slide/Analise-da-Serie-EPE-CE/Bases/CMEIC.xlsx"
dados_completos <- read_excel(file_path)

# Renomear colunas para facilitar o manuseio (assumindo a ordem das colunas)
colnames(dados_completos) <- c("data", "consumo_gwh")

# Filtrar dados para o estado do Cear√° (CE)
ceara_data <- dados_completos %>%
  mutate(data = as.Date(data)) %>%
  arrange(data)

# Gr√°fico da s√©rie temporal completa
ggplot(ceara_data, aes(x = data, y = consumo_gwh)) +
  geom_line(color = "#000000", size = 1) +
  labs(title = "Consumo Mensal de Energia El√©trica no Cear√° (Sistema Simples) (2004-2025)",
       subtitle = "Fonte: Empresa de Pesquisa Energ√©tica (EPE)",
       x = "Ano",
       y = "Consumo (MWh)") +
  theme_minimal()
```
## Apresenta√ß√£o da s√©rie:

Fazendo o gr√°fico box-plot separados por m√™s,quadrimestre e ano.

```{r, fig.align='center'}
teste = ceara_data %>%  rename( date = data , value = consumo_gwh)


teste %>%  plot_seasonal_diagnostics(date, value, .interactive = FALSE) 
```
Percebemos um aumento nos √∫ltimos meses do ano e valores de outliers em alguns anos.


## Divis√£o da S√©rie:

**Fazendo a divis√£o da s√©rie em teste e treino**
::: {style="font-size: 50%;"}
Ser√° feita um divis√£o na s√©rie em teste e treino, onde:

- A s√©rie de treino vai at√© o final do ano de 2022

- A s√©rie de teste come√ßa do ano de 2023 at√© mar√ßo de 2025

Assim sendo um divis√£o de 27 observa√ß√µes a serem prevista nos teste dos modelos
:::
```{}
# A s√©rie come√ßa em Janeiro de 2004
ts_ceara <- ts(ceara_data$consumo_gwh, start = c(2004, 1), frequency = 12)
# 2. Criar o conjunto de TREINO usando a fun√ß√£o window()
treino <- window(ts_ceara, end = c(2022, 12))
# 3. Criar o conjunto de TESTE usando a fun√ß√£o window()
teste <- window(ts_ceara, start = c(2023, 1), end = c(2025, 3))
```

```{r}
# A s√©rie come√ßa em Janeiro de 2004
ts_ceara <- ts(ceara_data$consumo_gwh, start = c(2004, 1), frequency = 12)
# 2. Criar o conjunto de TREINO usando a fun√ß√£o window()
treino <- window(ts_ceara, end = c(2022, 12))
# 3. Criar o conjunto de TESTE usando a fun√ß√£o window()
teste <- window(ts_ceara, start = c(2023, 1), end = c(2025, 3))

# --- Fun√ß√£o Aprimorada ---

#' Gera um painel de diagn√≥stico para uma s√©rie temporal.
#'
#' @param ts_object Um objeto de s√©rie temporal (classe ts).
#' @param titulo Um t√≠tulo geral para o painel de gr√°ficos.
#' @return Um objeto de gr√°fico patchwork contendo os diagn√≥sticos.

gerar_diagnostico_ts <- function(ts_object, titulo = "Painel de Diagn√≥stico da S√©rie Temporal") {
  
# 2. Gr√°fico da Fun√ß√£o de Autocorrela√ß√£o (ACF)
  p1 <- ggAcf(ts_object, lag.max = 36) +
    labs(title = "Autocorrela√ß√£o (ACF)") +
    theme_light()
  
  # 3. Gr√°fico da Fun√ß√£o de Autocorrela√ß√£o Parcial (PACF)
  p2 <- ggPacf(ts_object, lag.max = 36) +
    labs(title = "Autocorrela√ß√£o Parcial (PACF)") +
    theme_light()
  
 
  # 5. Organizar os gr√°ficos usando patchwork
  layout <- (p1 | p2) 
  
  # Adicionar um t√≠tulo geral ao painel
  plot_final <- layout + plot_annotation(title = titulo,
                                        theme = theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold")))
  
  return(plot_final)
}



gerar_diagnostico2_ts <- function(ts_object, titulo = "Painel de Diagn√≥stico da S√©rie Temporal") {
  
# 2. Gr√°fico da Fun√ß√£o de Autocorrela√ß√£o (ACF)
  p1 <- ggAcf(ts_object, lag.max = 36) +
    labs(title = "Autocorrela√ß√£o (ACF)") +
    theme_light()
  
  # 3. Gr√°fico da Fun√ß√£o de Autocorrela√ß√£o Parcial (PACF)
  p2 <- ggPacf(ts_object, lag.max = 36) +
    labs(title = "Autocorrela√ß√£o Parcial (PACF)") +
    theme_light()
  
  p3 <- autoplot(ts_object) +   geom_line(color = "#000000", size = 1) +  labs(title = "Gr√°fico da S√©rie",
       x = "Ano",
       y = "Consumo (MWh)") +
    theme_light()
 
  # 5. Organizar os gr√°ficos usando patchwork
  layout <- p3 / (p1 | p2)
  
  # Adicionar um t√≠tulo geral ao painel
  plot_final <- layout + plot_annotation(title = titulo,
                                        theme = theme(plot.title = element_text(hjust = 0.5, size = 16, face = "bold")))
  
  return(plot_final)
}





```

# M√©todo de Suaviza√ß√£o Exponencial

## M√©todo de Suaviza√ß√£o Exponencial

Passo a passo:

- A metodologia de suaviza√ß√£o exponencial foi aplicada usando a fun√ß√£o ets() do R.

Esta fun√ß√£o testa diferentes combina√ß√µes de componentes de Erro (E), Tend√™ncia (T) e Sazonalidade (S), selecionando o modelo que minimiza um crit√©rio de informa√ß√£o, como o AIC (Crit√©rio de Informa√ß√£o de Akaike). 

O modelo √© ajustado apenas com o conjunto de treino, ser√° selecionado apenas o que tiver o melhor AIC definido pela a fun√ß√£o do `ETS()` do **R**.


## M√©todo de Suaviza√ß√£o Exponencial

Fazendo a utiliza√ß√£o da chamada do modelo temos:


```{r}

modelo_ets <- ets(treino)
#summary(modelo_ets) 
#checkresiduals(modelo_ets)

```

```
modelo_ets <- ets(treino)

```

- Que o melhor modelo sugerido foi o ETS(M,Ad,M)

| Componente           | Tipo                | Significado                                                   |
| -------------------- | ------------------- | ------------------------------------------------------------- |
| **Erro (E)**         | M: Multiplicativo   | A variabilidade aumenta com o n√≠vel da s√©rie                  |
| **Tend√™ncia (T)**    | Ad: Aditiva Damping | Tend√™ncia aditiva com amortecimento (freia ao longo do tempo) |
| **Sazonalidade (S)** | M: Multiplicativa   | Sazonalidade proporcional ao n√≠vel da s√©rie                   |

## M√©todo de Suaviza√ß√£o Exponencial

- Formula do Modelo:

\begin{align*}
\textbf{Previs√£o:} \quad
\hat{y}_{t+h} &= (l_t + \phi^h b_t) \cdot s_{t+h-m(k+1)} \\[1em]

\textbf{Atualiza√ß√£o do n√≠vel:} \quad
l_t &= \alpha \cdot \frac{y_t}{s_{t-m}} + (1 - \alpha)(l_{t-1} + \phi b_{t-1}) \\[1em]

\textbf{Atualiza√ß√£o da tend√™ncia:} \quad
b_t &= \beta \cdot (l_t - l_{t-1}) + (1 - \beta) \cdot \phi b_{t-1} \\[1em]

\textbf{Atualiza√ß√£o da sazonalidade:} \quad
s_t &= \gamma \cdot \frac{y_t}{l_t} + (1 - \gamma) \cdot s_{t-m}
\end{align*}




## M√©todo de Suaviza√ß√£o Exponencial


```
summary(modelo_ets)

```
::: {style="font-size: 50%;"}
- Modelo selecionado pelo melhor AIC

* **Alpha (n√≠vel):** $\alpha = 0,7001$
* **Beta (tend√™ncia):** $\beta = 0,0038$
* **Gamma (sazonalidade):** $\gamma = 0,0001$
* **Damping:** $\phi = 0,9787$
* **N√≠vel inicial:** $l_0 = 506720,43$
* **Tend√™ncia inicial:** $b_0 = 3288,48$
* **Desvio Padr√£o dos erros:** $0,0313$
* **AIC:** $5878,418$

**Sazonalidade inicial:** $s_1 = 1,033, \ldots, s_{12} = 1,0149$
:::

## M√©todo de Suaviza√ß√£o Exponencial
::: {style="font-size: 50%;"}
**M√©tricas de desempenho no conjunto de treino:**

* RMSE: 26.608,53

* MAE: 19.550,13

* MAPE: 2,29% ‚áí Erro percentual muito baixo

* ACF dos res√≠duos: 0,066 ‚áí Baixa autocorrela√ß√£o

:::
## M√©todo de Suaviza√ß√£o Exponencial

- Formula do modelo

\begin{align*}
\hat{y}_{t+h} &= \left( 506720{,}43 + 0{,}9787^h \cdot 3288{,}48 \right) \cdot s_{t+h-12(k+1)} \\
l_t &= 0{,}7001 \cdot \frac{y_t}{s_{t-12}} + (1 - 0{,}7001)(l_{t-1} + 0{,}9787 \cdot b_{t-1}) \\
b_t &= 0{,}0038 \cdot (l_t - l_{t-1}) + (1 - 0{,}0038) \cdot 0{,}9787 \cdot b_{t-1} \\
s_t &= 0{,}0001 \cdot \frac{y_t}{l_t} + (1 - 0{,}0001) \cdot s_{t-12}
\end{align*}


## M√©todo de Suaviza√ß√£o Exponencial



```{r ,fig.align='center'}
gerar_diagnostico2_ts(modelo_ets$residuals) 
```

* Modelo quase ajustado

* Captura tend√™ncia suavizada e sazonalidade proporcional fraca

* Res√≠duos sem padr√£o aparente

## M√©todo de Suaviza√ß√£o Exponencial

```{r, fig.align='center'}

# Realizar a previs√£o para os pr√≥ximos 27 meses 
previsao_ets <- forecast(modelo_ets, h = 27)

# Gr√°fico da previs√£o vs. dados de teste 
autoplot(previsao_ets) +
  autolayer(teste, series="Dados Reais") +
  labs(title='Gr√°fico 1: Previs√£o com ETS(M,Ad,M) vs. Dados de Teste', 
       x='Ano', y='√çndice',
       caption = 'Linha azul: Previs√£o ETS. Sombreado: Intervalos de Confian√ßa.') +
  theme_minimal()
```

## M√©todo de Suaviza√ß√£o Exponencial

- Acur√°cia do Modelo ETS no Conjunto de Teste

```
print(acuracia_ets)
```

```{r ,fig.align='center'}
# Obter as medidas de ajuste no conjunto de teste 
acuracia_ets <- accuracy(previsao_ets, teste)
print(acuracia_ets)


```

O modelo apresenta um desempenho ruim no conjunto de teste. Embora tenha se ajustado razoavelmente bem aos dados de treinamento, ele n√£o conseguiu generalizar essa performance para os dados futuros (o conjunto de teste).

O modelo est√° superajustado (overfit) e tem um desempenho de previs√£o muito ruim, sendo inferior a um m√©todo de benchmark simples.


# Metodologia Box-Jenkins



## Metodologia Box-Jenkins


 Uma abordagem sistem√°tica para an√°lise e previs√£o de S√©ries Temporais



 **Modelo Central: ARIMA(p, d, q)**

O objetivo √© encontrar o modelo que melhor se ajusta aos dados.

* **AR (p): Autoregressivo**
    * Depend√™ncia dos **valores passados** da pr√≥pria s√©rie.
* **I (d): Integrado**
    * N√∫mero de **diferencia√ß√µes** necess√°rias para tornar a s√©rie estacion√°ria.
* **MA (q): M√©dia M√≥vel**
    * Depend√™ncia dos **erros de previs√£o passados**.


## Metodologia Box-Jenkins

::: {style="font-size: 50%;"}
 **Processo Iterativo em 4 Etapas**

1.  **Identifica√ß√£o do Modelo**
    * Verificar e ajustar a **estacionariedade** da s√©rie (usando diferencia√ß√£o `d`).
    * Analisar gr√°ficos de **Autocorrela√ß√£o (FAC)** e **Autocorrela√ß√£o Parcial (FACP)** para sugerir as ordens `p` e `q`.

2.  **Estima√ß√£o dos Par√¢metros**
    * Calcular os coeficientes do modelo ARIMA(p, d, q) candidato.

3.  **Verifica√ß√£o de Diagn√≥stico**
    * Analisar os **res√≠duos** do modelo: eles devem se comportar como ru√≠do branco (aleat√≥rios e sem padr√£o).
    * Se o modelo for inadequado, retorna-se √† Etapa 1.

4.  **Previs√£o**
    * Com um modelo validado, utiliz√°-lo para prever valores futuros.



**Pontos-Chave**

* **Guiado pelos Dados:** A estrutura do modelo √© definida pelos padr√µes encontrados nos pr√≥prios dados.
* **Iterativo:** √â um ciclo de identifica√ß√£o, ajuste e verifica√ß√£o.
* **Objetivo:** Construir um modelo estatisticamente robusto para gerar previs√µes precisas.

:::



## An√°lises Prim√°rias da s√©rie e Ajustes:

Podemos decompor a serie para ver a sazonalidade e estacion√°ridade,

```{r ,fig.align='center'}
# A s√©rie come√ßa em Janeiro de 2004
ts_ceara <- ts(ceara_data$consumo_gwh, start = c(2004, 1), frequency = 12)
# 2. Criar o conjunto de TREINO usando a fun√ß√£o window()
treino <- window(ts_ceara, end = c(2022, 12))
# 3. Criar o conjunto de TESTE usando a fun√ß√£o window()
teste <- window(ts_ceara, start = c(2023, 1), end = c(2025, 3))


# Decomposi√ß√£o da s√©rie temporal usando STL (Seasonal and Trend decomposition using Loess)
decomposicao <- stl(ts_ceara, s.window = "periodic")

autoplot(decomposicao, colour = "#0072B2") +
  
  # 1. Adicionar t√≠tulos, subt√≠tulos e legendas mais descritivas
  labs(
    title = "Decomposi√ß√£o STL da S√©rie Temporal",
    subtitle = "Componentes: Dados, Tend√™ncia, Sazonalidade e Res√≠duo",
    x = "Ano",
    y = ""  # Deixamos em branco para que os nomes dos pain√©is sirvam como r√≥tulos
  ) +
  
  # 2. Personalizar os elementos do tema do gr√°fico
  theme_minimal() +
  theme(
    # Formata√ß√£o do t√≠tulo principal
    plot.title = element_text(hjust = 0.5, size = 16, face = "bold", color = "gray20"),
    
    # Formata√ß√£o do subt√≠tulo
    plot.subtitle = element_text(hjust = 0.5, size = 12, color = "gray30"),
    
    # Formata√ß√£o do t√≠tulo do eixo X
    axis.title.x = element_text(size = 12, face = "italic"),
    
    # Formata√ß√£o do texto dos pain√©is (Data, Trend, etc.)
    strip.text = element_text(size = 11, face = "bold", color = "gray10"),
    
    # Ajustar as linhas de grade para um visual mais limpo
    panel.grid.major = element_line(colour = "gray90"),
    panel.grid.minor = element_blank(), # Remover linhas de grade menores
    
    # Adicionar um espa√ßo entre os pain√©is para melhor separa√ß√£o
    panel.spacing = unit(1.5, "lines") 
  )
```
**Percebe-se um tend√™ncia pr√°ticamente linear cresente e uma s√©rie serrote, vamos olhar os lags para ver se tem tend√™ncia.**


## An√°lises Prim√°rias da s√©rie e Ajustes:

```
adf.test(treino) 
kpss.test(treino) 

```

```{r}
adf.test(treino) 
kpss.test(treino) 

```

Com base nos resultados dos testes, a sua s√©rie temporal `treino` **n√£o √© estacion√°ria**.

## An√°lises Prim√°rias da s√©rie e Ajustes:

::: {style="font-size: 50%;"}

Ambos os testes, apesar de terem hip√≥teses opostas, apontam para a mesma conclus√£o.

***

 **Teste Augmented Dickey-Fuller (ADF)**

O teste ADF busca evid√™ncias de que a s√©rie *√© estacion√°ria*.

* **Hip√≥tese Nula ($H_0$)**: A s√©rie **n√£o √© estacion√°ria** (possui raiz unit√°ria).
* **Seu resultado**: O p-valor foi de **0.09388**.

Como o p-valor (0.09) √© **maior** que o n√≠vel de signific√¢ncia padr√£o (0.05), voc√™ **falha em rejeitar** a hip√≥tese nula. Isso significa que, segundo o teste ADF, a s√©rie √© considerada **n√£o estacion√°ria**.

***

 **Teste KPSS**

O teste KPSS, por outro lado, busca evid√™ncias de que a s√©rie *n√£o √© estacion√°ria*.

* **Hip√≥tese Nula ($H_0$)**: A s√©rie **√© estacion√°ria**.
* **Seu resultado**: O p-valor foi de **0.01**.

Como o p-valor (0.01) √© **menor** que o n√≠vel de signific√¢ncia (0.05), voc√™ **rejeita** a hip√≥tese nula. Isso significa que o teste KPSS tamb√©m conclui que a s√©rie √© **n√£o estacion√°ria**.

**Conclus√£o Final**

Ambos os testes confirmam que a s√©rie `treino` **n√£o √© estacion√°ria**. O pr√≥ximo passo na modelagem ARIMA seria aplicar a **diferencia√ß√£o** na s√©rie para tentar torn√°-la estacion√°ria. üëç

:::




## An√°lises Prim√°rias da s√©rie e Ajustes:

An√°lisando os lags da s√©rie:

```
gerar_diagnostico_ts(treino)
```

```{r ,fig.align='center'}

gerar_diagnostico_ts(treino)
```
Temos um forte evid√™ncia do modelo ser um autoregressivo de ordem 1 ou 2 e que a parte de m√©dias m√≥veis precisa tem um tratamento para aparecer, mesmo que no limte um sazonalidade no lag 12 ~ 14.


## An√°lises Prim√°rias da s√©rie e Ajustes:

An√°lisando os dados da S√©rie da **primeira diferan√ßa**:

```
ts_diff= diff(treino)
gerar_diagnostico2_ts(ts_diff)
adf.test(ts_diff)
kpss.test(ts_diff)
```


```{r, fig.align='center'}

ts_diff= diff(treino)
gerar_diagnostico2_ts(ts_diff)
#adf.test(ts_diff)
#kpss.test(ts_diff)

```
## An√°lises Prim√°rias da s√©rie e Ajustes:

**Principais Observa√ß√µes**

* **Estacionariedade:** A s√©rie se tornou estacion√°ria ap√≥s **1 diferencia√ß√£o** (`d=1`).

* **Sazonalidade Anual:** Padr√£o sazonal muito forte, com "spikes" significativos nos **lags 12 e 24** nos gr√°ficos ACF e PACF.
    * O spike claro no **PACF** no lag 12 sugere um componente **AR Sazonal (P=1)**.

* **Componente N√£o-Sazonal:** O **PACF** corta abruptamente ap√≥s o lag 1.
    * Isso sugere um componente **AR(1) (p=1)**.


## An√°lises Prim√°rias da s√©rie e Ajustes:

::: {style="font-size: 50%;"}
**Modelo Proposto Inicial: $SARIMA(1, 1, 1)(1, 0,0)^{12}$**

| Componente | Ordem | Justificativa |
| :--- | :---: | :--- |
| **p** (AR N√£o-sazonal) | **1** | Corte no PACF no lag 1 |
| **d** (Diferencia√ß√£o) | **1** | Aplicada para obter estacionariedade |
| **q** (MA N√£o-sazonal) | **1** | Ponto de partida simples |
| **P** (AR Sazonal) | **1** | Spike significativo no PACF no lag 12 |
| **D** (Dif. Sazonal) | **0** | N√£o parece necess√°ria a primeira vista |
| **Q** (MA Sazonal) | **0** | Ponto de partida simples |
| **s** (Per√≠odo Sazonal) | **12**| Padr√£o anual |

temos uma melhora da s√©rie e os testes de Dickey-Fuller e KPSS deu que a s√©rie √© estacionaria.

:::


 Os testes de Dickey-Fuller e KPSS deu que a s√©rie √© estacionaria.


## Sugest√£o Modelo 1
::: {style="font-size: 50%;"}

A f√≥rmula √©:

$SARIMA(1, 1, 1)(1, 0, 0)_{12}$

### Detalhamento dos Componentes

* **SARIMA**: Sigla para *Seasonal AutoRegressive Integrated Moving Average*.
* **(p, d, q) = (1, 0, 1)**: Esta √© a parte **n√£o sazonal** do modelo.
    * `p=1`: Um termo autorregressivo (AR).
    * `d=0`: Uma diferencia√ß√£o regular para tornar a s√©rie estacion√°ria.
    * `q=1`: Nenhum termo de m√©dia m√≥vel (MA).
* **(P, D, Q)m = (1, 0, 0)m**: Esta √© a parte **sazonal** do modelo.
    * `P=1`: Um termo autorregressivo sazonal.
    * `D=0`: Nenhuma diferencia√ß√£o sazonal.
    * `Q=0`: Nenhum termo de m√©dia m√≥vel sazonal.
    * `m`: Representa o per√≠odo da sazonalidade (por exemplo, `m=12` para dados mensais).

:::

## Sugest√£o Modelo 1
```
Modelo1 <- Arima(treino, order = c(1, 1, 1), seasonal = c(1,0,0))

summary(Modelo1)
```

```{r}
Modelo1 <- Arima(treino, order = c(1, 1, 1), seasonal = c(1,0,0))

summary(Modelo1)
```
## Sugest√£o Modelo 1

Equa√ß√£o Proposta 1:
$$(1 - \phi_1 B)(1 - \Phi_1 B^{12})(1-B) Y_t = (1 + \Theta_1 B) a_t$$

Substiduindo os valores obtidos, temos: 

$$
(1 - 0,7196 B)(1 - 0,2938B^{12})(1-B)Y_t = (1 -0.8920 B) a_t
$$

## Diagn√≥stico Modelo 1

```{r, fig.align='center'}
gerar_diagnostico2_ts(Modelo1$residuals) 

```

Os gr√°ficos indicam que os res√≠duos do modelo se comportam como ru√≠do branco, sem autocorrela√ß√£o, sugerindo um bom ajuste,mas que pode ser melhorado.


# Sugest√£o de um Modelo 2


## An√°lises Prim√°rias da s√©rie e Ajustes:

An√°lisando os dados da S√©rie da **primeira diferan√ßa normal e uma sazonal**:


```

ts_diff_12 = diff(diff(ts_ceara),12)
gerar_diagnostico2_ts(ts_diff_12 )
adf.test(ts_diff_12)
kpss.test(ts_diff_12)
```

```{r, fig.align='center'}

ts_diff_12 = diff(diff(ts_ceara),12)

gerar_diagnostico2_ts(ts_diff_12 )
#adf.test(ts_diff_12)
#kpss.test(ts_diff_12)

```



## Sugest√£o Modelo 2

::: {style="font-size: 50%;"}

A f√≥rmula √©:

$SARIMA(1, 1, 1)(1, 1, 1)_{12}$

### Detalhamento dos Componentes

* **SARIMA**: Sigla para *Seasonal AutoRegressive Integrated Moving Average*.
* **(p, d, q) = (1, 0, 1)**: Esta √© a parte **n√£o sazonal** do modelo.
    * `p=1`: Um termo autorregressivo (AR).
    * `d=1`: Uma diferencia√ß√£o regular para tornar a s√©rie estacion√°ria.
    * `q=1`: Uma termo de m√©dia m√≥vel (MA).
* **(P, D, Q)m = (1, 0, 0)m**: Esta √© a parte **sazonal** do modelo.
    * `P=1`: Um termo autorregressivo sazonal.
    * `D=1`: Um diferencia√ß√£o sazonal.
    * `Q=1`: Um termo de m√©dia m√≥vel sazonal.
    * `m`: Representa o per√≠odo da sazonalidade (por exemplo, `m=12` para dados mensais).

:::
$$
(1 - \phi_1 B)(1 - \Phi_1 B^{12})(1-B)(1-B^{12}) Y_t = (1 + \theta_1 B)(1 + \Theta_1 B^{12}) a_t
$$

## Sugest√£o Modelo 2

```
Modelo2 <- Arima(treino, order = c(1, 1, 1), seasonal = c(1,1,1))

summary(Modelo2)
```


```{r}
Modelo2 <- Arima(treino, order = c(1, 1, 1), seasonal = c(1,1,1))

summary(Modelo2)
```
::: {style="font-size: 60%;"}
O modelo SARIMA(1,1,1)(1,1,1)[12] apresenta um excelente ajuste aos dados de treinamento, com res√≠duos que se comportam como ru√≠do branco. No entanto, o modelo √© ligeiramente mais complexo do que o necess√°rio, pois um de seus coeficientes n√£o √© estatisticamente significativo, sugerindo que uma vers√£o simplificada seria mais adequada (parcimoniosa)
:::

## Sugest√£o Modelo 2

```{r, fig.align='center'}
gerar_diagnostico2_ts(Modelo2$residuals) 
```
::: {style="font-size: 50%;"}
Gr√°fico da S√©rie: Os res√≠duos flutuam aleatoriamente em torno de zero, sem qualquer tend√™ncia ou padr√£o vis√≠vel.

ACF e PACF: Os gr√°ficos de autocorrela√ß√£o e autocorrela√ß√£o parcial mostram que praticamente todos os lags est√£o dentro dos limites de signific√¢ncia (linhas azuis). Isso indica que n√£o h√° autocorrela√ß√£o remanescente, um forte sinal de que os res√≠duos se comportam como ru√≠do branco.
:::

## Sugest√£o Modelo 2

Assim esse √© o Modelo sugerido ideal ao meu ver,
$$(1 - 0.6463 B)(1 - 0.0834 B^{12})(1-B)(1-B^{12}) Y_t = $$
$$(1 - 0.9003 B)(1 - 0.9975 B^{12}) a_t$$



## Sugest√£o Modelo 2


```{r, fig.align='center'}
# Ajuste o modelo ARIMA

# Fa√ßa a previs√£o para os pr√≥ximos 24 per√≠odos (por exemplo, 2 anos)
previsao_modelo2 <- forecast(Modelo2,27)
# Gr√°fico da previs√£o vs. dados de teste 
autoplot(previsao_modelo2) +
  autolayer(teste, series="Dados Reais") +
  labs(title='Gr√°fico 2: Previs√£o com Sarima(1,1,1)x(1,1,1)12  vs. Dados de Teste', 
       x='Ano', y='√çndice',
       caption = 'Linha azul: Previs√£o ETS. Sombreado: Intervalos de Confian√ßa.') +
  theme_minimal()


```
# Modelo Final 

## Sugest√£o Modelo Final

o Ajuste para um modelo final foi removido o termo n√£o significativo sar1. O novo candidato, que deve ser o modelo final
√© o SARIMA(1,1,1)(0,1,1)[12]

```{r}
Modelo3 <- Arima(treino, order = c(1, 1, 1), seasonal = c(0,1,1))

summary(Modelo3)
```
## Sugest√£o Modelo Final

```{r}
gerar_diagnostico2_ts(Modelo3$residuals) 
```
## Sugest√£o Modelo Final

Este modelo SARIMA(1,1,1)(0,1,1)[12] √© a vers√£o otimizada e final. Ele √© mais simples, todos os seus componentes s√£o significativos, e ele se ajusta melhor aos dados segundo os crit√©rios de informa√ß√£o. O pr√≥ximo passo √© usar este modelo para fazer previs√µes e avaliar seu desempenho no conjunto de teste.

$$
(1 - 0.6370 B)(1-B)(1-B^{12}) Y_t = (1 - 0.8923 B)(1 - 0.9166 B^{12}) a_t
$$


## Previs√£o Modelo final
```{r, fig.align='center'}
# Ajuste o modelo ARIMA

# Fa√ßa a previs√£o para os pr√≥ximos 24 per√≠odos (por exemplo, 2 anos)
previsao_modelo3 <- forecast(Modelo3,27)
# Gr√°fico da previs√£o vs. dados de teste 
autoplot(previsao_modelo3) +
  autolayer(teste, series="Dados Reais") +
  labs(title='Gr√°fico 3: Previs√£o com Sarima(1,1,1)x(0,1,1)12  vs. Dados de Teste', 
       x='Ano', y='√çndice',
       caption = 'Linha azul: Previs√£o ETS. Sombreado: Intervalos de Confian√ßa.') +
  theme_minimal()


```



# An√°lise de Interven√ß√µes

```
detectAO(Modelo3)
detectIO(Modelo3)
```

```{r}
detectAO(Modelo3)
detectIO(Modelo3)
```
::: {style="font-size: 50%;"}
Este resultado indica que o algoritmo de detec√ß√£o de outliers encontrou um evento estatisticamente significativo na sua s√©rie temporal.

* **Evento Detectado:** Um outlier significativo foi identificado no **ponto de √≠ndice 196** da s√©rie .

* **Tipo de Outlier:** A mensagem `"No AO detected"` informa que n√£o foram encontrados Outliers Aditivos (pontos isolados at√≠picos). Portanto, o outlier encontrado no √≠ndice 196 √© de outro tipo, muito provavelmente uma **Mudan√ßa de N√≠vel (Level Shift - LS)**.

* **Signific√¢ncia e Impacto:** O valor `lambda1` (`-4.84`) √© a estat√≠stica-t do evento. Por ser um valor alto (em m√≥dulo), o outlier √© **altamente significativo**. O sinal negativo indica que houve uma **queda abrupta e permanente** no n√≠vel m√©dio da s√©rie a partir do ponto 196.

**Em resumo:** a an√°lise sugere que algo mudou estruturalmente na s√©rie no 196¬∫ per√≠odo que √© maio de 2020, causando uma queda em seu patamar. Isso deve ser incorporado ao modelo final para melhorar a precis√£o das previs√µes.
:::

# An√°lise de Interven√ß√µes

```{r}
# Primeiro, pegamos o tamanho do seu conjunto de treino
n_treino <- length(treino)

# Criamos um vetor de zeros com o mesmo tamanho do treino
# Este ser√° nosso regressor para o outlier
outlier_ao_196 <- rep(0, n_treino)

# Agora, colocamos o valor 1 na posi√ß√£o 196, que √© o √≠ndice do outlier
outlier_ao_196[196] <- 1
```


```{r}
# Ajuste o modelo SARIMA incluindo o regressor do outlier
# Use a fun√ß√£o Arima() do pacote forecast, que lida melhor com xreg
Modelo3_com_outlier <- Arima(treino, 
                             order = c(1, 1, 1), 
                             seasonal = list(order = c(0, 1, 1), period = 12),
                             xreg = outlier_ao_196) 

# Veja o resumo do novo modelo
summary(Modelo3_com_outlier)
```

::: {style="font-size: 50%;"}
O modelo combina uma regress√£o linear com um modelo **SARIMA `(1,1,1)(0,1,1)[12]`** para capturar a din√¢mica dos erros, o que √© uma abordagem poderosa.

* **Coeficientes Significativos:** Todos os coeficientes, incluindo o da vari√°vel externa (`xreg`), s√£o estatisticamente significativos. Isso indica que a vari√°vel `xreg` contribui de forma importante para a previs√£o.
* **Boa Acur√°cia:** O erro percentual absoluto m√©dio (**MAPE**) de **2.22%** √© geralmente considerado um bom n√≠vel de precis√£o.
* **Res√≠duos Limpos:** O valor de **ACF1** (-0.02) √© muito pr√≥ximo de zero, sugerindo que n√£o h√° autocorrela√ß√£o remanescente nos res√≠duos. Isso √© um forte indicativo de que a estrutura do modelo capturou bem os padr√µes dos dados.

::: 

# An√°lise de Interven√ß√µes

Fazendo agora o Gr√°fico de Previs√£o com a Interve√ß√£o colocada

```{r}
# Ajuste o modelo ARIMA
# Defina o horizonte de previs√£o (ex: 24 meses)
h_previsao <- 27

# Crie o xreg para o per√≠odo futuro. Como o outlier n√£o vai se repetir,
# ele ser√° um vetor de zeros.
xreg_futuro <- rep(0, h_previsao)
# Fa√ßa a previs√£o para os pr√≥ximos 24 per√≠odos (por exemplo, 2 anos)
previsao_modelo3 <- forecast(Modelo3_com_outlier,27,xreg = xreg_futuro)
# Gr√°fico da previs√£o vs. dados de teste 
autoplot(previsao_modelo2) +
  autolayer(teste, series="Dados Reais") +
  labs(title='Gr√°fico 4: Previs√£o com Sarima(1,1,1)x(0,1,1)12 Reg vs. Dados de Teste', 
       x='Ano', y='√çndice',
       caption = 'Linha azul: Previs√£o ETS. Sombreado: Intervalos de Confian√ßa.') +
  theme_minimal()
```

## Modelo Final 


::: {style="font-size: 50%;"}

| Componente | Termo na Equa√ß√£o | Valor/Par√¢metro Estimado | Descri√ß√£o |
| :--- | :--- | :--- | :--- |
| **Autorregressivo (AR)** | `(1 - 0.6219 B)` | `œÜ‚ÇÅ = 0.6219` | Modela a depend√™ncia do valor atual com o do per√≠odo anterior (mem√≥ria de curto prazo). |
| **M√©dia M√≥vel (MA)** | `(1 - 0.8848 B)` | `Œ∏‚ÇÅ = -0.8848` | Modela a depend√™ncia do valor atual com o erro de previs√£o do per√≠odo anterior. |
| **M√©dia M√≥vel Sazonal**| `(1 - 0.9295 B¬π¬≤)`| `Œò‚ÇÅ = -0.9295`| Modela a depend√™ncia com o erro de previs√£o do mesmo m√™s no ano anterior. |
| **Diferencia√ß√£o** | `(1 - B)(1 - B¬π¬≤)` | N/A (Operadores) | Remove a tend√™ncia e a sazonalidade para tornar a s√©rie estacion√°ria. |
| **Efeito da Interven√ß√£o**| `-64822.33 * ... * P_t`| `œâ = -64822.33`| O impacto imediato do evento, causando uma queda de ~64.8k unidades. |
| **Erro Aleat√≥rio** | `a_t` | N/A (Vari√°vel) | Flutua√ß√µes imprevis√≠veis restantes ap√≥s a modelagem dos outros componentes. |
:::

## Modelo Final 
Esta √© a equa√ß√£o do modelo final com interven√ß√£o, com os valores estimados a partir dos dados.

O coeficiente **-64822.33** (`œâ`) representa o **impacto imediato e pontual** do evento de interven√ß√£o (no tempo $T$). Isso significa que, no momento em que ocorreu, o evento causou uma **queda estimada de aproximadamente 64.822 unidades** no n√≠vel da s√©rie.

Os outros coeficientes (`ar1=0.6219`, `ma1=-0.8848`, `sma1=-0.9295`) definem a "mem√≥ria" da s√©rie, ou seja, como o efeito desse choque inicial e de outras flutua√ß√µes aleat√≥rias se dissipam e se propagam ao longo dos meses seguintes.


# Conclus√£o das an√°lises e modelos


## Conclus√£o das an√°lises e modelos

::: {style="font-size: 60%;"}

Avaliamos quatro modelos de duas fam√≠lias principais: **ARIMA** e **ETS**.

1.  **Regress√£o com Erros ARIMA (Din√¢mico)**
    * `Regression with ARIMA(1,1,1)(0,1,1)[12] errors`
    * Inclui uma vari√°vel externa (`xreg`) para melhorar a previs√£o.

2.  **ARIMA Sazonal (SARIMA)**
    * `ARIMA(1,1,1)(0,1,1)[12]`

3.  **ARIMA Sazonal (Alternativo)**
    * `ARIMA(1,1,1)(1,0,0)[12]`

4.  **ETS (Suaviza√ß√£o Exponencial)**
    * `ETS(M,Ad,M)` - (Erro Multiplicativo, Tend√™ncia Aditiva Amortecida, Sazonalidade Multiplicativa)

## Conclus√£o das an√°lises e modelos

### **Qualidade do Ajuste vs. Complexidade**
* **AIC, AICc, BIC:** Penalizam modelos complexos para evitar sobreajuste.
* ***Quanto menor, melhor.***

#### **Acur√°cia da Previs√£o (no treino)**
* **RMSE, MAE, MAPE:** Medem o erro m√©dio das previs√µes.
* ***Quanto menor, melhor.***

:::

##  Resultados: Qualidade do Ajuste 

Comparamos os crit√©rios de informa√ß√£o. Valores mais baixos indicam um melhor equil√≠brio entre o ajuste do modelo e sua simplicidade.

| Modelo | AIC | BIC |
| :--- | :--- | :--- |
| **Reg-ARIMA** üèÜ | **5029.19** | **5046.04** |
| ARIMA (0,1,1)[12] | 5035.95 | 5049.43 |
| ARIMA (1,0,0)[12] | 5326.89 | 5340.59 |
| ETS(M,Ad,M) | 5878.42 | 5940.15 |

**Conclus√£o:** O modelo **Regress√£o com Erros ARIMA** se mostra superior, sugerindo que a vari√°vel externa (`xreg`) adiciona valor real.

##  Resultados: Acur√°cia da Previs√£o 

Analisamos os erros de previs√£o no conjunto de dados de treino.

| Modelo | RMSE | MAE | MAPE (%) |
| :--- | :--- | :--- | :--- |
| **Reg-ARIMA** üèÜ | **26064.73** | **19178.95** | **2.22%** |
| ARIMA (0,1,1)[12] | 26697.04 | 19381.64 | 2.24% |
| ARIMA (1,0,0)[12] | 29490.90 | 22057.06 | 2.61% |
| ETS(M,Ad,M) | 26608.53 | 19550.13 | 2.29% |

**Conclus√£o:** O **Reg-ARIMA** consistentemente produz os menores erros, confirmando sua maior precis√£o.

---

##  O Veredito: O Modelo Vencedor 

O modelo **Regress√£o com Erros ARIMA(1,1,1)(0,1,1)[12]** √© a escolha recomendada.

### Por que ele venceu?

* ‚úÖ **Menores Crit√©rios de Informa√ß√£o (AIC & BIC):** Melhor equil√≠brio entre ajuste e complexidade.
* ‚úÖ **Menores Erros de Previs√£o (RMSE & MAE):** Previs√µes mais acuradas.
* ‚úÖ **Poder Explicativo Adicional:** A vari√°vel externa `xreg` √© estatisticamente significativa e melhora o desempenho do modelo em rela√ß√£o a um ARIMA puro.




# Refer√™ncias Te√≥ricas

- Box, G. E. P., Jenkins, G. M., Reinsel, G. C., & Ljung, G. M., *Time Series Analysis: Forecasting and Control* (Wiley Series in Probability and Statistics), 5th Edition.

- Brockwell, P. J., & Davis, R. A., *Time Series: Theory and Methods* (Springer Series in Statistics), 2nd Edition.

- Hamilton, J. D., *Time Series Analysis* (Princeton University Press), 1st Edition.

- Morettin, P. A., & Toloi, C. M. C., *S√©ries Temporais em R: An√°lise e Previs√£o* (Blucher), 1st Edition.

- Shumway, R. H., & Stoffer, D. S., *Time Series Analysis and Its Applications: With R Examples* (Springer Texts in Statistics), 4th Edition.

# Obrigado !! 
